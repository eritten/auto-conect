{% extends "base.html" %}

{% block title %}Complete Profile{% endblock %}

{% block content %}
<div class="container">
    <h2 class="text-center">Complete Your Profile</h2>
    
    <form method="post" enctype="multipart/form-data" action="{% url 'complete_profile' %}">
        {% csrf_token %}
        
        {% if form.non_field_errors %}
            <div class="alert alert-danger">
                {{ form.non_field_errors }}
            </div>
        {% endif %}

        <div class="form-group">
            <label for="id_user_type">User Type</label>
            {{ form.user_type }}
            {% if form.user_type.errors %}
                <div class="alert alert-danger">
                    {{ form.user_type.errors }}
                </div>
            {% endif %}
        </div>

        <div class="form-group" id="hourly_rate_field" style="display: {% if form.instance.user_type == 'dr' %}none{% else %}block{% endif %};">
            <label for="id_hourly_rate">Hourly Rate</label>
            {{ form.hourly_rate }}
            {% if form.hourly_rate.errors %}
                <div class="alert alert-danger">
                    {{ form.hourly_rate.errors }}
                </div>
            {% endif %}
        </div>

        <div class="form-group">
            <label for="id_profile_image">Profile Image</label>
            {{ form.profile_image }}
            {% if form.profile_image.errors %}
                <div class="alert alert-danger">
                    {{ form.profile_image.errors }}
                </div>
            {% endif %}
        </div>

        <div class="form-group">
            <label for="id_city">City</label>
            {{ form.city }}
            {% if form.city.errors %}
                <div class="alert alert-danger">
                    {{ form.city.errors }}
                </div>
            {% endif %}
        </div>

        <div class="form-group">
            <label for="id_lat">Latitude</label>
            {{ form.lat }}
            {% if form.lat.errors %}
                <div class="alert alert-danger">
                    {{ form.lat.errors }}
                </div>
            {% endif %}
        </div>

        <div class="form-group">
            <label for="id_long">Longitude</label>
            {{ form.long }}
            {% if form.long.errors %}
                <div class="alert alert-danger">
                    {{ form.long.errors }}
                </div>
            {% endif %}
        </div>

        <div class="form-group">
            <label for="id_bio">Bio</label>
            {{ form.bio }}
            {% if form.bio.errors %}
                <div class="alert alert-danger">
                    {{ form.bio.errors }}
                </div>
            {% endif %}
        </div>

        <div class="form-group">
            <label for="id_telephone_number">Telephone Number</label>
            {{ form.telephone_number }}
            {% if form.telephone_number.errors %}
                <div class="alert alert-danger">
                    {{ form.telephone_number.errors }}
                </div>
            {% endif %}
        </div>

        <button type="submit" class="btn btn-primary">Save Profile</button>
    </form>

    <div id="map" style="width: 100%; height: 400px;"></div>
</div>

<script>
    function showHideHourlyRate() {
        var userType = document.getElementById("id_user_type").value;
        var hourlyRateField = document.getElementById("hourly_rate_field");

        if (userType === "dr") {
            hourlyRateField.style.display = "none";
        } else {
            hourlyRateField.style.display = "block";
        }
    }

    document.addEventListener("DOMContentLoaded", function() {
        showHideHourlyRate(); // Set the initial state
        document.getElementById("id_user_type").addEventListener("change", showHideHourlyRate);
    });

    mapboxgl.accessToken = '{{ mapbox_token }}'; // Replace with your actual Mapbox access token
    var map = new mapboxgl.Map({
        container: 'map',
        style: 'mapbox://styles/mapbox/streets-v11',
        center: [{{ form.long.value|default:"-0.1276" }}, {{ form.lat.value|default:"51.5074" }}], // Default to London
        zoom: 12
    });

    var marker = new mapboxgl.Marker({
        draggable: true
    })
    .setLngLat([{{ form.long.value|default:"-0.1276" }}, {{ form.lat.value|default:"51.5074" }}])
    .addTo(map);

    function onDragEnd() {
        var lngLat = marker.getLngLat();
        document.getElementById('id_lat').value = lngLat.lat;
        document.getElementById('id_long').value = lngLat.lng;
    }

    marker.on('dragend', onDragEnd);
</script>
<script src="https://api.mapbox.com/mapbox-gl-js/v2.3.1/mapbox-gl.js"></script>
<link href="https://api.mapbox.com/mapbox-gl-js/v2.3.1/mapbox-gl.css" rel="stylesheet" />
{% endblock %}
